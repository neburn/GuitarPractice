function updateLibraryDisplay() {
            const type = appState.currentLibraryType;
            const items = appState.data[type];
            
            // Update title and button text
            const titles = {
                songs: { title: 'üéµ Your Songs', add: 'Add Song', form: '‚ûï Add New Song' },
                exercises: { title: 'üí™ Your Exercises', add: 'Add Exercise', form: '‚ûï Add New Exercise' },
                repertoire: { title: '‚≠ê Your Repertoire', add: 'Add Repertoire', form: '‚ûï Add New Repertoire' }
            };
            
            document.getElementById('itemsListTitle').textContent = titles[type].title;
            document.getElementById('addBtnText').textContent = titles[type].add;
            document.getElementById('addItemTitle').textContent = titles[type].form;
            
            // Show/hide artist field for songs and repertoire
            const artistGroup = document.getElementById('artistGroup');
            artistGroup.style.display = (type === 'songs' || type === 'repertoire') ? 'block' : 'none';
            
            // Update counts
            document.getElementById(type + 'Count').textContent = items.length;
            
            // Update items list
            const itemsList =         /* Goal Display */
        .goal-display {
            max-width: 300px;
            margin: 0 auto;
        }

        .goal-current {
            font-size: 36px;
            font-weight: bold;
            color: var(--sidebar-active);
            margin-bottom: 5px;
        }

        .goal-target {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .goal-bar {
            height: 12px;
            background: var(--card-border);
            border-radius: 6px;
            overflow: hidden;
        }

        .goal-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--button-success), var(--sidebar-active));
            transition: width 0.3s ease;
        }

        /* Routine Items with Drag Handle */
        .routine-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--card-border);
            background: var(--input-background);
            margin-bottom: 2px;
            border-radius: 4px;
        }

        .drag-handle {
            cursor: grab;
            padding: 4px;
            margin-right: 8px;
            color: var(--text-muted);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .routine-item.dragging {
            opacity: 0.5;
        }

        .break-item {
            background: linear-gradient(90deg, #FFC107, #FF8F00);
            color: #000;
        }

        .break-item .drag-handle {
            color: #666;
        }        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-icon {
            background: var(--card-background);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            border-radius: var(--corner-radius);
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .btn-icon:hover {
            background: var(--card-border);
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Practice Manager</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Practice Manager">
    
    <!-- Mobile optimizations -->
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    
    <style>
        :root {
            --background: #2D2D2D;
            --sidebar: #1E1E1E;
            --sidebar-active: #4A90E2;
            --card-background: #3A3A3A;
            --card-border: #4A4A4A;
            --button-primary: #4A90E2;
            --button-primary-hover: #357ABD;
            --button-success: #28A745;
            --button-success-hover: #218838;
            --button-danger: #DC3545;
            --button-danger-hover: #C82333;
            --text-primary: #FFFFFF;
            --text-secondary: #CCCCCC;
            --text-muted: #999999;
            --input-background: #4A4A4A;
            --input-border: #5A5A5A;
            --corner-radius: 12px;
            --header-height: 80px;
            --nav-height: 60px;
            --card-padding: 20px;
            --element-spacing: 15px;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .app-header {
            height: var(--header-height);
            background: var(--sidebar);
            border-bottom: 1px solid var(--card-border);
            padding: 0 20px;
        }

        .header-content {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-icon {
            font-size: 32px;
        }

        .title-text h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: var(--text-primary);
        }

        .subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
        }

        /* Navigation */
        .tab-navigation {
            background: var(--sidebar);
            border-bottom: 1px solid var(--card-border);
            padding: 0 20px;
            display: flex;
            justify-content: center;
            gap: 5px;
            padding: 8px 20px;
        }

        .tab-button {
            background: var(--card-background);
            border: none;
            color: var(--text-secondary);
            padding: 12px 20px;
            border-radius: var(--corner-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            min-width: 120px;
            justify-content: center;
        }

        .tab-button:hover {
            background: var(--card-border);
            color: var(--text-primary);
        }

        .tab-button.active {
            background: var(--sidebar-active);
            color: var(--text-primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--card-background);
            border: 1px solid var(--card-border);
            border-radius: var(--corner-radius);
            margin-bottom: var(--element-spacing);
            overflow: hidden;
        }

        .card-header {
            padding: var(--card-padding);
            border-bottom: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-header h3 {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
            margin: 0;
        }

        /* Timer Display */
        .timer-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--element-spacing);
        }

        .timer-display-container {
            text-align: center;
            padding: 40px var(--card-padding);
        }

        .timer-display {
            font-size: 48px;
            font-weight: bold;
            font-family: monospace;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .timer-display.running {
            color: var(--button-success);
        }

        .timer-display.paused {
            color: #FFC107;
        }

        .timer-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            padding: var(--card-padding);
            padding-top: 0;
        }

        /* Forms */
        .input-group {
            margin-bottom: var(--element-spacing);
            padding: 0 var(--card-padding);
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: var(--corner-radius);
            background: var(--input-background);
            color: var(--text-primary);
            font-size: 12px;
            font-family: var(--font-family);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--button-primary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: var(--corner-radius);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--button-primary);
            color: var(--text-primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--button-primary-hover);
        }

        .btn-success {
            background: var(--button-success);
            color: var(--text-primary);
        }

        .btn-success:hover:not(:disabled) {
            background: var(--button-success-hover);
        }

        .btn-danger {
            background: var(--button-danger);
            color: var(--text-primary);
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--button-danger-hover);
        }

        .btn-warning {
            background: #FFC107;
            color: var(--text-primary);
        }

        .btn-warning:hover:not(:disabled) {
            background: #E0A800;
        }

        /* Library Layout */
        .library-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--element-spacing);
        }

        .library-nav {
            display: flex;
            gap: 10px;
            margin-bottom: var(--element-spacing);
        }

        .library-tab-btn {
            background: var(--card-background);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            padding: 12px 16px;
            border-radius: var(--corner-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .library-tab-btn.active {
            background: var(--sidebar-active);
            color: var(--text-primary);
            border-color: var(--sidebar-active);
        }

        .library-tab-btn:hover {
            background: var(--card-border);
            color: var(--text-primary);
        }

        .count {
            background: var(--card-border);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }

        .library-tab-btn.active .count {
            background: rgba(255,255,255,0.2);
            color: var(--text-primary);
        }

        /* Items List */
        .items-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .item-card {
            background: var(--input-background);
            border: 1px solid var(--card-border);
            border-radius: var(--corner-radius);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info h4 {
            margin: 0 0 5px 0;
            color: var(--text-primary);
            font-size: 14px;
        }

        .item-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 11px;
            min-width: auto;
        }

        /* Routines Grid */
        .routines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--element-spacing);
        }

        .routine-card {
            background: var(--input-background);
            border: 1px solid var(--card-border);
            border-radius: var(--corner-radius);
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .routine-card:hover {
            border-color: var(--sidebar-active);
            transform: translateY(-2px);
        }

        .routine-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .routine-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
            margin: 0;
        }

        .routine-duration {
            background: var(--button-success);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
        }

        .routine-items {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .routine-actions {
            display: flex;
            gap: 10px;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--element-spacing);
            margin-bottom: var(--element-spacing);
        }

        .stat-card {
            background: var(--card-background);
            border: 1px solid var(--card-border);
            border-radius: var(--corner-radius);
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--sidebar-active);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            border: 1px solid var(--card-border);
            border-radius: var(--corner-radius);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .btn-close:hover {
            background: var(--card-border);
        }

        .modal-body {
            padding: 20px;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-background);
            border: 1px solid var(--card-border);
            border-radius: var(--corner-radius);
            padding: 15px 20px;
            color: var(--text-primary);
            z-index: 10001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            border-left: 4px solid var(--button-success);
        }

        .toast-error {
            border-left: 4px solid var(--button-danger);
        }

        .toast-warning {
            border-left: 4px solid #FFC107;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
            }
            
            .timer-layout,
            .library-layout {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .routines-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-navigation {
                overflow-x: auto;
                justify-content: flex-start;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .tab-navigation::-webkit-scrollbar {
                display: none;
            }
            
            .tab-button {
                min-width: 90px;
                flex-shrink: 0;
                padding: 10px 12px;
                font-size: 11px;
            }
            
            .timer-display {
                font-size: 36px;
            }
            
            .timer-display-container {
                padding: 20px 10px;
            }
            
            .timer-controls {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .timer-controls .btn {
                height: 50px;
                font-size: 16px;
            }
            
            .card-header {
                padding: 15px;
            }
            
            .card-header h3 {
                font-size: 16px;
            }
            
            .input-group {
                padding: 0 15px;
                margin-bottom: 12px;
            }
            
            .library-nav {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .library-tab-btn {
                flex: 1;
                min-width: 80px;
                padding: 10px 8px;
                font-size: 11px;
            }
            
            .item-card {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .item-actions {
                justify-content: center;
                width: 100%;
            }
            
            .routine-card {
                padding: 15px;
            }
            
            .routine-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .routine-actions {
                justify-content: center;
                width: 100%;
            }
            
            .modal-content {
                width: 95vw;
                max-height: 90vh;
                margin: 20px auto;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .goal-display {
                margin: 0 auto 20px;
            }
            
            .goal-current {
                font-size: 28px;
            }
            
            /* Touch-friendly buttons */
            .btn {
                min-height: 44px;
                touch-action: manipulation;
            }
            
            .btn-small {
                min-height: 36px;
                padding: 8px 12px;
            }
            
            .form-input,
            .form-select,
            .form-textarea {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            /* Routine progress optimizations */
            #routineProgressCard {
                order: -1; /* Show at top on mobile */
            }
            
            .routine-item {
                padding: 12px;
                font-size: 14px;
            }
            
            .drag-handle {
                font-size: 18px;
                padding: 8px;
            }
            
            /* Header optimizations */
            .app-header {
                height: 60px;
            }
            
            .header-content {
                padding: 0 15px;
            }
            
            .app-title {
                gap: 10px;
            }
            
            .app-icon {
                font-size: 24px;
            }
            
            .title-text h1 {
                font-size: 18px;
            }
            
            .subtitle {
                font-size: 12px;
            }
            
            .header-actions .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            /* Toast positioning */
            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }
            
            /* Chart responsiveness */
            #practiceChart {
                max-width: 100%;
                height: auto;
            }
            
            /* Settings modal mobile */
            .modal-content {
                border-radius: 8px;
            }
            
            /* Form improvements */
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            /* Skip button more prominent on mobile */
            #skipItemBtn {
                height: 50px;
                font-size: 16px;
                font-weight: bold;
            }
        }

        /* Landscape phone optimizations */
        @media (max-width: 768px) and (orientation: landscape) {
            .timer-display {
                font-size: 28px;
            }
            
            .timer-display-container {
                padding: 15px 10px;
            }
            
            .timer-controls {
                grid-template-columns: 1fr 1fr 1fr;
            }
            
            .app-header {
                height: 50px;
            }
        }

        /* Very small screens */
        @media (max-width: 480px) {
            .main-content {
                padding: 8px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .tab-button {
                min-width: 70px;
                padding: 8px 6px;
            }
            
            .timer-display {
                font-size: 32px;
            }
            
            .library-tab-btn {
                padding: 8px 6px;
                font-size: 10px;
            }
            
            .routine-card {
                padding: 12px;
            }
        }

        /* Improved touch targets */
        .btn, .tab-button, .library-tab-btn {
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }

        /* Better scrolling on mobile */
        .items-list,
        .routines-grid,
        #routineItemsProgress {
            -webkit-overflow-scrolling: touch;
        }

        /* Prevent text selection on interactive elements */
        .tab-button, .btn, .library-tab-btn, .routine-card {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-title">
                    <span class="app-icon">üé∏</span>
                    <div class="title-text">
                        <h1>Practice Manager</h1>
                        <p class="subtitle">Track your practice sessions</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" id="settingsBtn">
                        <span>‚öôÔ∏è</span>
                        <span>Settings</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="tab-navigation">
            <button class="tab-button active" data-tab="practice">
                <span>‚è±Ô∏è</span>
                <span>Practice</span>
            </button>
            <button class="tab-button" data-tab="library">
                <span>üìö</span>
                <span>Library</span>
            </button>
            <button class="tab-button" data-tab="routines">
                <span>üìã</span>
                <span>Routines</span>
            </button>
            <button class="tab-button" data-tab="statistics">
                <span>üìä</span>
                <span>Statistics</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Practice Tab -->
            <section id="practice-tab" class="tab-content active">
                <div class="timer-layout">
                    <!-- Timer Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3>‚è±Ô∏è Practice Timer</h3>
                            <span id="timerStatus">Ready</span>
                        </div>
                        
                        <div class="timer-display-container">
                            <div class="timer-display" id="timerDisplay">00:00:00</div>
                        </div>

                        <div class="input-group">
                            <label for="practiceItem">What are you practicing?</label>
                            <select id="practiceItem" class="form-select">
                                <option value="">Select an item...</option>
                            </select>
                        </div>

                        <div class="timer-controls">
                            <button class="btn btn-success" id="startBtn">
                                <span>‚ñ∂Ô∏è</span>
                                <span>Start</span>
                            </button>
                            <button class="btn btn-warning" id="pauseBtn" disabled>
                                <span>‚è∏Ô∏è</span>
                                <span>Pause</span>
                            </button>
                            <button class="btn btn-danger" id="stopBtn" disabled>
                                <span>‚èπÔ∏è</span>
                                <span>Stop</span>
                            </button>
                        </div>
                    </div>

                    <!-- Session Notes -->
                    <div class="card">
                        <div class="card-header">
                            <h3>üìù Session Notes</h3>
                            <span id="notesStatus"></span>
                        </div>
                        <div class="input-group">
                            <textarea id="sessionNotes" class="form-textarea" rows="6" 
                                placeholder="What did you work on? Any breakthroughs or challenges?"></textarea>
                        </div>
                    </div>

                    <!-- Routine Progress (when practicing routine) -->
                    <div class="card" id="routineProgressCard" style="display: none;">
                        <div class="card-header">
                            <h3>üìã Routine Progress</h3>
                            <span id="routineProgress">0 / 0</span>
                        </div>
                        <div id="routineItemsProgress"></div>
                        <div style="padding: 0 20px 20px;">
                            <button class="btn btn-warning" id="skipItemBtn" style="width: 100%;">
                                ‚è≠Ô∏è Skip Current Item
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Library Tab -->
            <section id="library-tab" class="tab-content">
                <div class="library-nav">
                    <button class="library-tab-btn active" data-type="songs">
                        <span>üéµ</span>
                        <span>Songs</span>
                        <span class="count" id="songsCount">0</span>
                    </button>
                    <button class="library-tab-btn" data-type="exercises">
                        <span>üí™</span>
                        <span>Exercises</span>
                        <span class="count" id="exercisesCount">0</span>
                    </button>
                    <button class="library-tab-btn" data-type="repertoire">
                        <span>‚≠ê</span>
                        <span>Repertoire</span>
                        <span class="count" id="repertoireCount">0</span>
                    </button>
                </div>

                <div class="library-layout">
                    <!-- Add Item Form -->
                    <div class="card">
                        <div class="card-header">
                            <h3 id="addItemTitle">‚ûï Add New Song</h3>
                        </div>
                        <form id="addItemForm">
                            <div class="input-group">
                                <label for="itemName">Name *</label>
                                <input type="text" id="itemName" class="form-input" required>
                            </div>
                            <div class="input-group" id="artistGroup">
                                <label for="itemArtist">Artist</label>
                                <input type="text" id="itemArtist" class="form-input">
                            </div>
                            <div class="input-group">
                                <label for="itemTags">Tags</label>
                                <input type="text" id="itemTags" class="form-input" 
                                    placeholder="e.g., blues, fingerpicking, beginner">
                            </div>
                            <div class="input-group">
                                <label for="itemNotes">Notes</label>
                                <textarea id="itemNotes" class="form-textarea" rows="3"></textarea>
                            </div>
                            <div class="input-group">
                                <button type="submit" class="btn btn-success">
                                    <span>‚ûï</span>
                                    <span id="addBtnText">Add Song</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Items List -->
                    <div class="card">
                        <div class="card-header">
                            <h3 id="itemsListTitle">üéµ Your Songs</h3>
                        </div>
                        <div class="items-list" id="itemsList">
                            <div class="empty-state">
                                <span class="empty-icon">üéµ</span>
                                <p>No songs yet. Add your first song!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Routines Tab -->
            <section id="routines-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3>üìã Practice Routines</h3>
                        <button class="btn btn-primary" id="createRoutineBtn">
                            <span>‚ûï</span>
                            <span>Create Routine</span>
                        </button>
                    </div>
                    
                    <div class="routines-grid" id="routinesGrid">
                        <div class="empty-state">
                            <span class="empty-icon">üìã</span>
                            <p>No routines yet. Create your first routine!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Statistics Tab -->
            <section id="statistics-tab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalTime">0h 0m</div>
                        <div class="stat-label">Total Practice Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalSessions">0</div>
                        <div class="stat-label">Practice Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="averageSession">0m</div>
                        <div class="stat-label">Average Session</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dailyGoalProgress">0%</div>
                        <div class="stat-label">Daily Goal Progress</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>üéØ Daily Goal</h3>
                        <button class="btn btn-primary btn-small" id="editDailyGoal">Edit Goal</button>
                    </div>
                    <div style="padding: 20px; text-align: center;">
                        <div class="goal-display">
                            <div class="goal-current" id="goalCurrent">0 min</div>
                            <div class="goal-target">of <span id="goalTarget">60</span> min goal</div>
                            <div class="goal-bar">
                                <div class="goal-progress" id="goalProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>üìä Practice History</h3>
                    </div>
                    <div style="padding: 20px;">
                        <canvas id="practiceChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Create Routine Modal -->
    <div id="createRoutineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Create New Routine</h3>
                <button class="btn-close" id="closeCreateRoutine">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="routineName">Routine Name</label>
                    <input type="text" id="routineName" class="form-input" placeholder="e.g., Morning Warmup">
                </div>
                <div class="input-group">
                    <label>Add Items to Routine</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <select id="routineItemSelect" class="form-select" style="flex: 1;">
                            <option value="">Select an item to add...</option>
                        </select>
                        <button type="button" class="btn btn-primary" id="addToRoutineBtn">Add Item</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-warning" id="addBreakBtn">
                            ‚òï Add Break
                        </button>
                        <input type="number" id="breakDuration" class="form-input" placeholder="Minutes" 
                               style="width: 100px;" min="1" max="60" value="5">
                    </div>
                </div>
                <div class="input-group">
                    <label>Routine Items</label>
                    <div id="routineItemsList" style="min-height: 100px; border: 1px solid var(--card-border); border-radius: 8px; padding: 10px;">
                        <p style="color: var(--text-muted); text-align: center; margin: 30px 0;">No items added yet</p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-danger" id="cancelCreateRoutine">Cancel</button>
                    <button class="btn btn-success" id="saveRoutine">Save Routine</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Settings</h3>
                <button class="btn-close" id="closeSettings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="themeSelect">Theme</label>
                    <select id="themeSelect" class="form-select">
                        <option value="dark">Dark</option>
                        <option value="light">Light</option>
                        <option value="system">System</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="dailyGoalInput">Daily Practice Goal (minutes)</label>
                    <input type="number" id="dailyGoalInput" class="form-input" min="5" max="480" value="60">
                </div>
                
                <div class="input-group">
                    <label>Data Management</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="exportDataBtn">üì§ Export Data</button>
                        <button class="btn btn-primary" id="importDataBtn">üì• Import Data</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                        <button class="btn btn-danger" id="clearDataBtn">üóëÔ∏è Clear All Data</button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-danger" id="cancelSettings">Cancel</button>
                    <button class="btn btn-success" id="saveSettings">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Goal Edit Modal -->
    <div id="dailyGoalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üéØ Edit Daily Goal</h3>
                <button class="btn-close" id="closeDailyGoal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="newDailyGoal">Daily Practice Goal (minutes)</label>
                    <input type="number" id="newDailyGoal" class="form-input" min="5" max="480" value="60">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-danger" id="cancelDailyGoal">Cancel</button>
                    <button class="btn btn-success" id="saveDailyGoal">Save Goal</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application State
        const appState = {
            activeTab: 'practice',
            currentLibraryType: 'songs',
            timer: {
                isRunning: false,
                isPaused: false,
                startTime: null,
                elapsed: 0,
                currentItem: null,
                currentRoutine: null,
                currentRoutineIndex: 0
            },
            settings: {
                theme: 'dark',
                dailyGoal: 60
            },
            data: {
                songs: [],
                exercises: [],
                repertoire: [],
                routines: [],
                sessions: [],
                notes: {}
            },
            currentRoutine: { name: '', items: [] }
        };

        let timerInterval = null;

        // Initialize App
        function initApp() {
            loadData();
            setupEventListeners();
            updateUI();
        }

        // Event Listeners
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabId = e.currentTarget.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Library navigation
            document.querySelectorAll('.library-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.currentTarget.getAttribute('data-type');
                    switchLibraryType(type);
                });
            });

            // Timer controls
            document.getElementById('startBtn').addEventListener('click', startTimer);
            document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
            document.getElementById('stopBtn').addEventListener('click', stopTimer);
            document.getElementById('skipItemBtn').addEventListener('click', skipRoutineItem);

            // Session notes
            document.getElementById('sessionNotes').addEventListener('input', saveSessionNotes);

            // Add item form
            document.getElementById('addItemForm').addEventListener('submit', handleAddItem);

            // Settings
            document.getElementById('settingsBtn').addEventListener('click', showSettingsModal);
            document.getElementById('closeSettings').addEventListener('click', hideSettingsModal);
            document.getElementById('cancelSettings').addEventListener('click', hideSettingsModal);
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importFile').click());
            document.getElementById('importFile').addEventListener('change', importData);
            document.getElementById('clearDataBtn').addEventListener('click', clearAllData);

            // Daily goal
            document.getElementById('editDailyGoal').addEventListener('click', showDailyGoalModal);
            document.getElementById('closeDailyGoal').addEventListener('click', hideDailyGoalModal);
            document.getElementById('cancelDailyGoal').addEventListener('click', hideDailyGoalModal);
            document.getElementById('saveDailyGoal').addEventListener('click', saveDailyGoal);

            // Create routine
            document.getElementById('createRoutineBtn').addEventListener('click', showCreateRoutineModal);
            document.getElementById('closeCreateRoutine').addEventListener('click', hideCreateRoutineModal);
            document.getElementById('cancelCreateRoutine').addEventListener('click', hideCreateRoutineModal);
            document.getElementById('saveRoutine').addEventListener('click', saveRoutine);
            document.getElementById('addToRoutineBtn').addEventListener('click', addItemToRoutine);
            document.getElementById('addBreakBtn').addEventListener('click', addBreakToRoutine);

            // Modal close on outside click
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    hideSettingsModal();
                    hideCreateRoutineModal();
                    hideDailyGoalModal();
                }
            });

            // Theme handling
            document.getElementById('themeSelect').addEventListener('change', (e) => {
                setTheme(e.target.value);
            });
        }

        // Tab Management
        function switchTab(tabId) {
            // Update navigation
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');

            appState.activeTab = tabId;

            // Load tab-specific data
            if (tabId === 'statistics') {
                updateStatistics();
            } else if (tabId === 'routines') {
                updateRoutinesDisplay();
            }
        }

        function switchLibraryType(type) {
            document.querySelectorAll('.library-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');

            appState.currentLibraryType = type;
            updateLibraryDisplay();
        }

        // Timer Functions
        function startTimer() {
            const selectedItem = document.getElementById('practiceItem').value;
            if (!selectedItem) {
                showToast('Please select an item to practice!', 'warning');
                return;
            }

            if (appState.timer.isPaused) {
                // Resume
                appState.timer.startTime = Date.now() - appState.timer.elapsed;
                appState.timer.isPaused = false;
            } else {
                // Fresh start
                appState.timer.startTime = Date.now();
                appState.timer.elapsed = 0;
                appState.timer.currentItem = selectedItem;
                
                // Check if it's a routine
                if (selectedItem.startsWith('Routine: ')) {
                    const routineName = selectedItem.substring(9);
                    const routine = appState.data.routines.find(r => r.name === routineName);
                    if (routine) {
                        appState.timer.currentRoutine = routine;
                        appState.timer.currentRoutineIndex = 0;
                        updateRoutineProgress();
                    }
                }
            }

            appState.timer.isRunning = true;
            updateTimerButtons();
            
            timerInterval = setInterval(updateTimer, 1000);
            showToast('Timer started!', 'success');
        }

        function pauseTimer() {
            appState.timer.isRunning = false;
            appState.timer.isPaused = true;
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            updateTimerButtons();
            showToast('Timer paused', 'warning');
        }

        function stopTimer() {
            const sessionDuration = Math.floor(appState.timer.elapsed / 1000);
            
            appState.timer.isRunning = false;
            appState.timer.isPaused = false;
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Save session if longer than 1 minute
            if (sessionDuration >= 60) {
                saveSession(appState.timer.currentItem, sessionDuration);
                showToast('Session saved!', 'success');
            }
            
            // Reset timer
            appState.timer.elapsed = 0;
            appState.timer.startTime = null;
            appState.timer.currentItem = null;
            appState.timer.currentRoutine = null;
            appState.timer.currentRoutineIndex = 0;
            
            updateTimerDisplay();
            updateTimerButtons();
            updateRoutineProgress();
            updateStatistics();
        }

        function skipRoutineItem() {
            if (!appState.timer.currentRoutine) return;
            
            appState.timer.currentRoutineIndex++;
            
            if (appState.timer.currentRoutineIndex >= appState.timer.currentRoutine.items.length) {
                // Routine completed
                showToast('Routine completed!', 'success');
                stopTimer();
            } else {
                updateRoutineProgress();
                showToast('Skipped to next item', 'info');
            }
        }

        function updateRoutineProgress() {
            const progressCard = document.getElementById('routineProgressCard');
            const progressText = document.getElementById('routineProgress');
            const progressItems = document.getElementById('routineItemsProgress');
            
            if (!appState.timer.currentRoutine) {
                progressCard.style.display = 'none';
                return;
            }
            
            progressCard.style.display = 'block';
            const current = appState.timer.currentRoutineIndex + 1;
            const total = appState.timer.currentRoutine.items.length;
            progressText.textContent = `${current} / ${total}`;
            
            // Show current and next items
            progressItems.innerHTML = appState.timer.currentRoutine.items.map((item, index) => {
                const isActive = index === appState.timer.currentRoutineIndex;
                const isDone = index < appState.timer.currentRoutineIndex;
                const classes = `routine-item ${isActive ? 'active' : ''} ${isDone ? 'done' : ''}`;
                const icon = isDone ? '‚úÖ' : isActive ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
                
                return `
                    <div class="${classes}" style="padding: 8px; ${isActive ? 'background: var(--sidebar-active); color: white;' : ''}">
                        <span>${icon}</span>
                        <span style="margin-left: 8px;">${item.name} (${item.duration}m)</span>
                    </div>
                `;
            }).join('');
        }

        function updateTimer() {
            if (appState.timer.isRunning && appState.timer.startTime) {
                appState.timer.elapsed = Date.now() - appState.timer.startTime;
                updateTimerDisplay();
            }
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            const seconds = Math.floor(appState.timer.elapsed / 1000);
            display.textContent = formatTime(seconds);
            
            if (appState.timer.isRunning) {
                display.classList.add('running');
                display.classList.remove('paused');
                document.title = `${formatTime(seconds)} - Practice Manager`;
            } else if (appState.timer.isPaused) {
                display.classList.add('paused');
                display.classList.remove('running');
            } else {
                display.classList.remove('running', 'paused');
                document.title = 'Practice Manager';
            }
        }

        function updateTimerButtons() {
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (appState.timer.isRunning) {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                startBtn.innerHTML = '<span>‚ñ∂Ô∏è</span><span>Running...</span>';
            } else if (appState.timer.isPaused) {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = false;
                startBtn.innerHTML = '<span>‚ñ∂Ô∏è</span><span>Resume</span>';
            } else {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                startBtn.innerHTML = '<span>‚ñ∂Ô∏è</span><span>Start</span>';
            }
        }

        // Library Functions
        function handleAddItem(e) {
            e.preventDefault();
            
            const name = document.getElementById('itemName').value.trim();
            const artist = document.getElementById('itemArtist').value.trim();
            const tags = document.getElementById('itemTags').value.split(',').map(t => t.trim()).filter(t => t);
            const notes = document.getElementById('itemNotes').value.trim();
            
            if (!name) {
                showToast('Name is required!', 'error');
                return;
            }
            
            const item = {
                id: Date.now(),
                name,
                artist,
                tags,
                notes,
                practiceCount: 0,
                addedDate: new Date().toISOString()
            };
            
            appState.data[appState.currentLibraryType].push(item);
            saveData();
            updateLibraryDisplay();
            updatePracticeItemsSelect();
            
            // Clear form
            document.getElementById('addItemForm').reset();
            
            showToast(`${item.name} added successfully!`, 'success');
        }

        function updateLibraryDisplay() {
            const type = appState.currentLibraryType;
            const items = appState.data[type];
            
            // Update title and button text
            const titles = {
                songs: { title: 'üéµ Your Songs', add: 'Add Song', form: '‚ûï Add New Song' },
                exercises: { title: 'üí™ Your Exercises', add: 'Add Exercise', form: '‚ûï Add New Exercise' },
                repertoire: { title: '‚≠ê Your Repertoire', add: 'Add Repertoire', form: '‚ûï Add New Repertoire' }
            };
            
            document.getElementById('itemsListTitle').textContent = titles[type].title;
            document.getElementById('addBtnText').textContent = titles[type].add;
            document.getElementById('addItemTitle').textContent = titles[type].form;
            
            // Show/hide artist field for songs and repertoire
            const artistGroup = document.getElementById('artistGroup');
            artistGroup.style.display = (type === 'songs' || type === 'repertoire') ? 'block' : 'none';
            
            // Update counts
            document.getElementById(type + 'Count').textContent = items.length;
            
            // Update items list
            const itemsList = document.getElementById('itemsList');
            
            if (items.length === 0) {
                itemsList.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-icon">${type === 'songs' ? 'üéµ' : type === 'exercises' ? 'üí™' : '‚≠ê'}</span>
                        <p>No ${type} yet. Add your first ${type.slice(0, -1)}!</p>
                    </div>
                `;
                return;
            }
            
            itemsList.innerHTML = items.map(item => `
                <div class="item-card">
                    <div class="item-info">
                        <h4>${item.name}</h4>
                        <div class="item-meta">
                            ${item.artist ? `${item.artist} ‚Ä¢ ` : ''}
                            ${item.practiceCount} sessions
                            ${item.tags.length ? ` ‚Ä¢ ${item.tags.join(', ')}` : ''}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-primary btn-small" onclick="quickPractice('${item.name}', '${type}')">
                            üéØ Practice
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteItem(${item.id}, '${type}')">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Settings Functions
        function showSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            document.getElementById('themeSelect').value = appState.settings.theme;
            document.getElementById('dailyGoalInput').value = appState.settings.dailyGoal;
        }

        function hideSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            appState.settings.theme = document.getElementById('themeSelect').value;
            appState.settings.dailyGoal = parseInt(document.getElementById('dailyGoalInput').value);
            
            setTheme(appState.settings.theme);
            saveData();
            updateStatistics();
            hideSettingsModal();
            showToast('Settings saved!', 'success');
        }

        function setTheme(theme) {
            appState.settings.theme = theme;
            
            if (theme === 'system') {
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            
            if (theme === 'light') {
                document.documentElement.style.setProperty('--background', '#FFFFFF');
                document.documentElement.style.setProperty('--sidebar', '#F8F9FA');
                document.documentElement.style.setProperty('--card-background', '#FFFFFF');
                document.documentElement.style.setProperty('--card-border', '#DEE2E6');
                document.documentElement.style.setProperty('--text-primary', '#212529');
                document.documentElement.style.setProperty('--text-secondary', '#6C757D');
                document.documentElement.style.setProperty('--text-muted', '#ADB5BD');
                document.documentElement.style.setProperty('--input-background', '#FFFFFF');
                document.documentElement.style.setProperty('--input-border', '#CED4DA');
            } else {
                // Dark theme (default)
                document.documentElement.style.setProperty('--background', '#2D2D2D');
                document.documentElement.style.setProperty('--sidebar', '#1E1E1E');
                document.documentElement.style.setProperty('--card-background', '#3A3A3A');
                document.documentElement.style.setProperty('--card-border', '#4A4A4A');
                document.documentElement.style.setProperty('--text-primary', '#FFFFFF');
                document.documentElement.style.setProperty('--text-secondary', '#CCCCCC');
                document.documentElement.style.setProperty('--text-muted', '#999999');
                document.documentElement.style.setProperty('--input-background', '#4A4A4A');
                document.documentElement.style.setProperty('--input-border', '#5A5A5A');
            }
        }

        function exportData() {
            const dataToExport = {
                ...appState.data,
                settings: appState.settings,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `practice-manager-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data exported successfully!', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate and merge data
                    if (importedData.songs) appState.data.songs = importedData.songs;
                    if (importedData.exercises) appState.data.exercises = importedData.exercises;
                    if (importedData.repertoire) appState.data.repertoire = importedData.repertoire;
                    if (importedData.routines) appState.data.routines = importedData.routines;
                    if (importedData.sessions) appState.data.sessions = importedData.sessions;
                    if (importedData.notes) appState.data.notes = importedData.notes;
                    if (importedData.settings) appState.settings = { ...appState.settings, ...importedData.settings };
                    
                    saveData();
                    updateUI();
                    setTheme(appState.settings.theme);
                    showToast('Data imported successfully!', 'success');
                    
                } catch (error) {
                    showToast('Error importing data. Please check the file format.', 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                appState.data = {
                    songs: [],
                    exercises: [],
                    repertoire: [],
                    routines: [],
                    sessions: [],
                    notes: {}
                };
                saveData();
                updateUI();
                showToast('All data cleared', 'warning');
            }
        }

        // Daily Goal Functions
        function showDailyGoalModal() {
            document.getElementById('dailyGoalModal').style.display = 'block';
            document.getElementById('newDailyGoal').value = appState.settings.dailyGoal;
        }

        function hideDailyGoalModal() {
            document.getElementById('dailyGoalModal').style.display = 'none';
        }

        function saveDailyGoal() {
            const newGoal = parseInt(document.getElementById('newDailyGoal').value);
            if (newGoal >= 5 && newGoal <= 480) {
                appState.settings.dailyGoal = newGoal;
                saveData();
                updateStatistics();
                hideDailyGoalModal();
                showToast('Daily goal updated!', 'success');
            } else {
                showToast('Goal must be between 5 and 480 minutes', 'error');
            }
        }

        // Session Notes Functions
        function saveSessionNotes() {
            const notes = document.getElementById('sessionNotes').value;
            const currentItem = appState.timer.currentItem || 'general';
            appState.data.notes[currentItem] = notes;
            saveData();
            
            // Update status indicator
            const status = document.getElementById('notesStatus');
            status.textContent = '‚úì Saved';
            status.style.color = 'var(--button-success)';
            setTimeout(() => {
                status.textContent = '';
            }, 2000);
        }

        function loadSessionNotes() {
            const currentItem = appState.timer.currentItem || 'general';
            const notes = appState.data.notes[currentItem] || '';
            document.getElementById('sessionNotes').value = notes;
        }

        // Routine Functions with Breaks and Reordering
        function addBreakToRoutine() {
            const duration = parseInt(document.getElementById('breakDuration').value) || 5;
            
            appState.currentRoutine.items.push({
                name: `‚òï Break`,
                duration: duration,
                type: 'break'
            });
            
            updateRoutineItemsDisplay();
        }

        function updateRoutineItemsDisplay() {
            const container = document.getElementById('routineItemsList');
            
            if (appState.currentRoutine.items.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; margin: 30px 0;">No items added yet</p>';
                return;
            }
            
            const totalDuration = appState.currentRoutine.items.reduce((sum, item) => sum + item.duration, 0);
            
            container.innerHTML = `
                <div style="margin-bottom: 15px; padding: 10px; background: var(--input-background); border-radius: 8px;">
                    <strong>Total Duration: ${totalDuration} minutes</strong>
                </div>
                ${appState.currentRoutine.items.map((item, index) => `
                    <div class="routine-item ${item.type === 'break' ? 'break-item' : ''}" draggable="true" data-index="${index}">
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        <span style="flex: 1;">${index + 1}. ${item.name} (${item.duration}m)</span>
                        <button class="btn btn-danger btn-small" onclick="removeFromRoutine(${index})">√ó</button>
                    </div>
                `).join('')}
            `;
            
            // Add drag and drop functionality
            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            const items = document.querySelectorAll('.routine-item[draggable="true"]');
            
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.index);
                    e.target.classList.add('dragging');
                });
                
                item.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
                
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetIndex = parseInt(e.target.closest('.routine-item').dataset.index);
                    
                    if (draggedIndex !== targetIndex) {
                        // Reorder items
                        const items = appState.currentRoutine.items;
                        const draggedItem = items[draggedIndex];
                        items.splice(draggedIndex, 1);
                        items.splice(targetIndex, 0, draggedItem);
                        
                        updateRoutineItemsDisplay();
                    }
                });
            });
        }

        function deleteItem(id, type) {
            if (confirm('Are you sure you want to delete this item?')) {
                appState.data[type] = appState.data[type].filter(item => item.id !== id);
                saveData();
                updateLibraryDisplay();
                updatePracticeItemsSelect();
                showToast('Item deleted', 'success');
            }
        }

        function quickPractice(itemName, type) {
            const typeLabels = {
                songs: 'Song',
                exercises: 'Exercise', 
                repertoire: 'Repertoire'
            };
            
            const displayName = `${typeLabels[type]}: ${itemName}`;
            document.getElementById('practiceItem').value = displayName;
            switchTab('practice');
            showToast(`Ready to practice ${itemName}!`, 'success');
        }

        // Routines Functions
        function showCreateRoutineModal() {
            document.getElementById('createRoutineModal').style.display = 'block';
            updateRoutineItemsSelect();
            clearRoutineForm();
        }

        function hideCreateRoutineModal() {
            document.getElementById('createRoutineModal').style.display = 'none';
        }

        function updateRoutineItemsSelect() {
            const select = document.getElementById('routineItemSelect');
            const allItems = [
                ...appState.data.songs.map(s => ({ name: s.name, type: 'Song' })),
                ...appState.data.exercises.map(e => ({ name: e.name, type: 'Exercise' })),
                ...appState.data.repertoire.map(r => ({ name: r.name, type: 'Repertoire' }))
            ];
            
            select.innerHTML = '<option value="">Select an item to add...</option>' + 
                allItems.map(item => `<option value="${item.type}: ${item.name}">${item.type}: ${item.name}</option>`).join('');
        }

        function addItemToRoutine() {
            const select = document.getElementById('routineItemSelect');
            const selectedItem = select.value;
            
            if (!selectedItem) {
                showToast('Please select an item to add', 'warning');
                return;
            }
            
            const duration = prompt('Duration in minutes:', '5');
            if (!duration || isNaN(duration) || duration <= 0) {
                showToast('Please enter a valid duration', 'error');
                return;
            }
            
            appState.currentRoutine.items.push({
                name: selectedItem,
                duration: parseInt(duration)
            });
            
            updateRoutineItemsDisplay();
            select.value = '';
        }

        function updateRoutineItemsDisplay() {
            const container = document.getElementById('routineItemsList');
            
            if (appState.currentRoutine.items.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; margin: 30px 0;">No items added yet</p>';
                return;
            }
            
            const totalDuration = appState.currentRoutine.items.reduce((sum, item) => sum + item.duration, 0);
            
            container.innerHTML = `
                <div style="margin-bottom: 15px; padding: 10px; background: var(--input-background); border-radius: 8px;">
                    <strong>Total Duration: ${totalDuration} minutes</strong>
                </div>
                ${appState.currentRoutine.items.map((item, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--card-border);">
                        <span>${index + 1}. ${item.name} (${item.duration}m)</span>
                        <button class="btn btn-danger btn-small" onclick="removeFromRoutine(${index})">√ó</button>
                    </div>
                `).join('')}
            `;
        }

        function removeFromRoutine(index) {
            appState.currentRoutine.items.splice(index, 1);
            updateRoutineItemsDisplay();
        }

        function saveRoutine() {
            const name = document.getElementById('routineName').value.trim();
            
            if (!name) {
                showToast('Please enter a routine name', 'error');
                return;
            }
            
            if (appState.currentRoutine.items.length === 0) {
                showToast('Please add at least one item to the routine', 'error');
                return;
            }
            
            const routine = {
                id: Date.now(),
                name,
                items: [...appState.currentRoutine.items],
                createdDate: new Date().toISOString()
            };
            
            appState.data.routines.push(routine);
            saveData();
            updateRoutinesDisplay();
            updatePracticeItemsSelect();
            hideCreateRoutineModal();
            
            showToast(`Routine "${name}" created!`, 'success');
        }

        function clearRoutineForm() {
            document.getElementById('routineName').value = '';
            appState.currentRoutine = { name: '', items: [] };
            updateRoutineItemsDisplay();
        }

        function updateRoutinesDisplay() {
            const container = document.getElementById('routinesGrid');
            
            if (appState.data.routines.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-icon">üìã</span>
                        <p>No routines yet. Create your first routine!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appState.data.routines.map(routine => {
                const totalDuration = routine.items.reduce((sum, item) => sum + item.duration, 0);
                return `
                    <div class="routine-card">
                        <div class="routine-header">
                            <h3 class="routine-title">${routine.name}</h3>
                            <span class="routine-duration">${totalDuration}m</span>
                        </div>
                        <div class="routine-items">
                            ${routine.items.length} items ‚Ä¢ Created ${new Date(routine.createdDate).toLocaleDateString()}
                        </div>
                        <div class="routine-actions">
                            <button class="btn btn-success btn-small" onclick="practiceRoutine('${routine.name}')">
                                üéØ Practice
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteRoutine(${routine.id})">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function practiceRoutine(routineName) {
            document.getElementById('practiceItem').value = `Routine: ${routineName}`;
            switchTab('practice');
            showToast(`Ready to practice ${routineName}!`, 'success');
        }

        function deleteRoutine(id) {
            if (confirm('Are you sure you want to delete this routine?')) {
                appState.data.routines = appState.data.routines.filter(routine => routine.id !== id);
                saveData();
                updateRoutinesDisplay();
                updatePracticeItemsSelect();
                showToast('Routine deleted', 'success');
            }
        }

        // Statistics Functions with Daily Goal
        function updateStatistics() {
            const sessions = appState.data.sessions;
            
            if (sessions.length === 0) {
                document.getElementById('totalTime').textContent = '0h 0m';
                document.getElementById('totalSessions').textContent = '0';
                document.getElementById('averageSession').textContent = '0m';
                document.getElementById('dailyGoalProgress').textContent = '0%';
                updateDailyGoalDisplay(0);
                return;
            }
            
            const totalTime = sessions.reduce((sum, session) => sum + session.duration, 0);
            const totalSessions = sessions.length;
            const averageSession = Math.floor(totalTime / totalSessions);
            
            // Calculate today's progress
            const today = new Date().toDateString();
            const todaySessions = sessions.filter(session => 
                new Date(session.date).toDateString() === today
            );
            const todayTime = todaySessions.reduce((sum, session) => sum + session.duration, 0);
            const todayMinutes = Math.floor(todayTime / 60);
            const goalProgress = Math.min((todayMinutes / appState.settings.dailyGoal) * 100, 100);
            
            document.getElementById('totalTime').textContent = formatTime(totalTime);
            document.getElementById('totalSessions').textContent = totalSessions;
            document.getElementById('averageSession').textContent = formatTime(averageSession);
            document.getElementById('dailyGoalProgress').textContent = Math.round(goalProgress) + '%';
            
            updateDailyGoalDisplay(todayMinutes);
            drawPracticeChart(sessions);
        }

        function updateDailyGoalDisplay(currentMinutes) {
            document.getElementById('goalCurrent').textContent = `${currentMinutes} min`;
            document.getElementById('goalTarget').textContent = appState.settings.dailyGoal;
            
            const progress = Math.min((currentMinutes / appState.settings.dailyGoal) * 100, 100);
            document.getElementById('goalProgressBar').style.width = progress + '%';
        }

        function drawPracticeChart(sessions) {
            const canvas = document.getElementById('practiceChart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (sessions.length === 0) {
                ctx.fillStyle = '#999999';
                ctx.font = '16px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText('No practice data yet', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Group sessions by date (last 7 days)
            const dailyData = {};
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                dailyData[dateStr] = 0;
            }
            
            sessions.forEach(session => {
                const sessionDate = new Date(session.date).toDateString();
                if (dailyData.hasOwnProperty(sessionDate)) {
                    dailyData[sessionDate] += Math.floor(session.duration / 60);
                }
            });
            
            const dates = Object.keys(dailyData);
            const values = Object.values(dailyData);
            const maxValue = Math.max(...values, 1);
            
            // Draw chart
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const barWidth = chartWidth / dates.length * 0.8;
            const barSpacing = chartWidth / dates.length * 0.2;
            
            ctx.fillStyle = '#4A90E2';
            
            values.forEach((value, index) => {
                const barHeight = (value / maxValue) * chartHeight;
                const x = padding + index * (barWidth + barSpacing);
                const y = canvas.height - padding - barHeight;
                
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Draw value
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '12px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText(value + 'm', x + barWidth / 2, y - 5);
                
                // Draw day label
                const dayName = new Date(dates[index]).toLocaleDateString('en-US', { weekday: 'short' });
                ctx.fillText(dayName, x + barWidth / 2, canvas.height - padding + 20);
                
                ctx.fillStyle = '#4A90E2';
            });
        }

        // Data Management with Notes
        function saveSession(item, duration) {
            const session = {
                id: Date.now(),
                item,
                duration,
                date: new Date().toISOString(),
                notes: appState.data.notes[item] || ''
            };
            
            appState.data.sessions.push(session);
            
            // Update practice count for the item
            updatePracticeCount(item);
            
            saveData();
        }

        function saveData() {
            const dataToSave = {
                ...appState.data,
                settings: appState.settings
            };
            localStorage.setItem('practiceManagerData', JSON.stringify(dataToSave));
        }

        function loadData() {
            const saved = localStorage.getItem('practiceManagerData');
            if (saved) {
                try {
                    const loadedData = JSON.parse(saved);
                    appState.data = {
                        songs: loadedData.songs || [],
                        exercises: loadedData.exercises || [],
                        repertoire: loadedData.repertoire || [],
                        routines: loadedData.routines || [],
                        sessions: loadedData.sessions || [],
                        notes: loadedData.notes || {}
                    };
                    appState.settings = {
                        theme: loadedData.settings?.theme || 'dark',
                        dailyGoal: loadedData.settings?.dailyGoal || 60
                    };
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
        }

        function updatePracticeCount(itemName) {
            const [type, name] = itemName.split(': ');
            const typeMap = {
                'Song': 'songs',
                'Exercise': 'exercises', 
                'Repertoire': 'repertoire'
            };
            
            const dataType = typeMap[type];
            if (dataType && appState.data[dataType]) {
                const item = appState.data[dataType].find(i => i.name === name);
                if (item) {
                    item.practiceCount = (item.practiceCount || 0) + 1;
                }
            }
        }

        function updatePracticeItemsSelect() {
            const select = document.getElementById('practiceItem');
            const allItems = [
                ...appState.data.songs.map(s => `Song: ${s.name}`),
                ...appState.data.exercises.map(e => `Exercise: ${e.name}`),
                ...appState.data.repertoire.map(r => `Repertoire: ${r.name}`),
                ...appState.data.routines.map(r => `Routine: ${r.name}`)
            ];
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select an item...</option>' + 
                allItems.map(item => `<option value="${item}">${item}</option>`).join('');
            
            if (allItems.includes(currentValue)) {
                select.value = currentValue;
            }
            
            // Load notes for selected item
            loadSessionNotes();
        }

        function updateUI() {
            updateLibraryDisplay();
            updateRoutinesDisplay();
            updatePracticeItemsSelect();
            updateStatistics();
            updateTimerDisplay();
            updateTimerButtons();
            setTheme(appState.settings.theme);
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            
            // Watch for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if (appState.settings.theme === 'system') {
                    setTheme('system');
                }
            });
            
            // Mobile optimizations
            setupMobileOptimizations();
        });

        // Mobile-specific optimizations
        function setupMobileOptimizations() {
            // Prevent zoom on double tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Handle orientation changes
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    // Force recalculation of layout
                    updateUI();
                }, 500);
            });
            
            // Optimize scrolling on mobile
            if ('scrollBehavior' in document.documentElement.style) {
                document.documentElement.style.scrollBehavior = 'smooth';
            }
            
            // Better drag and drop on mobile
            if (window.navigator.maxTouchPoints > 0) {
                setupMobileDragAndDrop();
            }
        }

        function setupMobileDragAndDrop() {
            // Enhanced mobile drag and drop for routine items
            let draggedElement = null;
            let touchStartY = 0;
            let dragOffset = 0;
            
            document.addEventListener('touchstart', function(e) {
                const target = e.target.closest('.routine-item[draggable="true"]');
                if (target && e.target.closest('.drag-handle')) {
                    draggedElement = target;
                    touchStartY = e.touches[0].clientY;
                    target.style.opacity = '0.7';
                    target.style.transform = 'scale(1.05)';
                    e.preventDefault();
                }
            });
            
            document.addEventListener('touchmove', function(e) {
                if (draggedElement) {
                    const currentY = e.touches[0].clientY;
                    dragOffset = currentY - touchStartY;
                    draggedElement.style.transform = `translateY(${dragOffset}px) scale(1.05)`;
                    e.preventDefault();
                }
            });
            
            document.addEventListener('touchend', function(e) {
                if (draggedElement) {
                    const target = document.elementFromPoint(
                        e.changedTouches[0].clientX,
                        e.changedTouches[0].clientY
                    );
                    const targetItem = target?.closest('.routine-item[draggable="true"]');
                    
                    if (targetItem && targetItem !== draggedElement) {
                        const draggedIndex = parseInt(draggedElement.dataset.index);
                        const targetIndex = parseInt(targetItem.dataset.index);
                        
                        // Reorder items
                        const items = appState.currentRoutine.items;
                        const draggedItem = items[draggedIndex];
                        items.splice(draggedIndex, 1);
                        items.splice(targetIndex, 0, draggedItem);
                        
                        updateRoutineItemsDisplay();
                    }
                    
                    draggedElement.style.opacity = '';
                    draggedElement.style.transform = '';
                    draggedElement = null;
                }
            });
        }

        // Utility Functions
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m`;
            } else {
                return `${secs}s`;
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
    </script>
</body>
</html>
